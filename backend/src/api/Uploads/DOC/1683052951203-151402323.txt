import express from "express";
import { addOrder, getOrders, updateOrder, deleteOrder } from '../controllers/orderBookController.js'
import { chkAdminStatus, requireSignin } from '../middlware/index.js'
import { fileURLToPath } from "url"
import multer from 'multer'
import shID from 'shortid'
import path from 'path'
import slugify from 'slugify'

const router = express.Router()

const fileName = fileURLToPath(import.meta.url)
const __dirName = path.dirname(path.dirname(fileName))

const storage = multer.diskStorage({
    destination: function (req, file, cb) {
        cb(null, path.join(__dirName, `/uploads/${file.fieldname}`))
    },
    filename: function (req, file, cb) {
        cb(null, shID.generate() + '-' + slugify(file.originalname))
    }
})

const limits = {
    files: 2,
    fileSize: 1024 * 1024 * 10
};

const fileFilter = function (req, file, cb) {
    const allowedMimes = ['application/pdf'];

    if (allowedMimes.includes(file.mimetype)) {
        cb(null, true);
    } else {
        cb(new Error('Invalid file type. Only pdf files are allowed.'));
    }
};

const upload = multer({ storage, limits, fileFilter })

router.post("/order/add", requireSignin, chkAdminStatus, addOrder);
router.get("/order/get", requireSignin, chkAdminStatus, getOrders);
router.post("/order/update", requireSignin, chkAdminStatus, upload.fields([{ name: 'po_pdf', maxCount: 1 }, { name: 'bond_pdf', maxCount: 1 }]), updateOrder);
router.post("/order/delete", requireSignin, chkAdminStatus, deleteOrder);

export default router